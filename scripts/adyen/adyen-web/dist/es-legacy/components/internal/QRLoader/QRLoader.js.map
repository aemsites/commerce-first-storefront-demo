{"version":3,"file":"QRLoader.js","sources":["../../../../../src/components/internal/QRLoader/QRLoader.tsx"],"sourcesContent":["import { Component, h } from 'preact';\nimport Countdown from '../Countdown';\nimport Button from '../Button';\nimport Spinner from '../Spinner';\nimport checkPaymentStatus from '../../../core/Services/payment-status';\nimport processResponse from '../../../core/ProcessResponse';\n\nimport './QRLoader.scss';\nimport { QRLoaderProps, QRLoaderState } from './types';\nimport copyToClipboard from '../../../utils/clipboard';\nimport AdyenCheckoutError from '../../../core/Errors/AdyenCheckoutError';\nimport { useCoreContext } from '../../../core/Context/CoreProvider';\nimport ContentSeparator from '../ContentSeparator';\nimport { StatusObject } from '../Await/types';\nimport useImage from '../../../core/Context/useImage';\nimport { useA11yReporter } from '../../../core/Errors/useA11yReporter';\nimport useAutoFocus from '../../../utils/useAutoFocus';\nimport { ANALYTICS_DOWNLOAD_STR, ANALYTICS_QR_CODE_DOWNLOAD } from '../../../core/Analytics/constants';\nimport { PREFIX } from '../Icon/constants';\n\nconst QRCODE_URL = 'barcode.shtml?barcodeType=qrCode&fileType=png&data=';\n\nclass QRLoader extends Component<QRLoaderProps, QRLoaderState> {\n    private timeoutId;\n\n    constructor(props) {\n        super(props);\n\n        this.state = {\n            buttonStatus: 'default',\n            completed: false,\n            delay: props.delay,\n            expired: false,\n            loading: true,\n            percentage: 100,\n            timePassed: 0\n        };\n    }\n\n    public static defaultProps = {\n        delay: 2000,\n        countdownTime: 15,\n        onError: () => {},\n        onComplete: () => {},\n        throttleTime: 60000,\n        classNameModifiers: [],\n        throttledInterval: 10000,\n        introduction: 'wechatpay.scanqrcode',\n        timeToPay: 'wechatpay.timetopay',\n        buttonLabel: 'openApp'\n    };\n\n    componentDidMount() {\n        this.statusInterval();\n    }\n\n    componentWillUnmount() {\n        clearTimeout(this.timeoutId);\n    }\n\n    public redirectToApp = (url: string | URL) => {\n        window.location.assign(url);\n    };\n\n    // Retry until getting a complete response from the server, or it times out\n    public statusInterval = (responseTime = 0) => {\n        // If we are already in the final statuses, do not poll!\n        if (this.state.expired || this.state.completed) return;\n\n        this.setState(previous => ({ timePassed: previous.timePassed + this.props.delay + responseTime }));\n        // Changes interval time to 10 seconds after 1 minute (60 seconds)\n        const newDelay = this.state.timePassed >= this.props.throttleTime ? this.props.throttledInterval : this.state.delay;\n        this.pollStatus(newDelay);\n    };\n\n    private pollStatus(delay: number) {\n        clearTimeout(this.timeoutId);\n\n        // eslint-disable-next-line @typescript-eslint/no-misused-promises\n        this.timeoutId = setTimeout(async () => {\n            // Wait for previous status call to finish.\n            // Also taking the server response time into the consideration to calculate timePassed.\n            const start = performance.now();\n            await this.checkStatus();\n            const end = performance.now();\n            this.statusInterval(Math.round(end - start));\n        }, delay);\n    }\n\n    private onTick = (time): void => {\n        this.setState({ percentage: time.percentage });\n    };\n\n    private onTimeUp = (): void => {\n        this.setState({ expired: true });\n        clearTimeout(this.timeoutId);\n        this.props.onError(new AdyenCheckoutError('ERROR', 'Payment Expired'));\n    };\n\n    private onComplete = (status: StatusObject): void => {\n        clearTimeout(this.timeoutId);\n        this.setState({ completed: true, loading: false });\n\n        const state = {\n            data: {\n                details: { payload: status.props.payload },\n                paymentData: this.props.paymentData\n            }\n        };\n\n        this.props.onComplete(state, this);\n    };\n\n    private onError = (status: StatusObject): void => {\n        clearTimeout(this.timeoutId);\n        this.setState({ expired: true, loading: false });\n\n        if (status.props.payload) {\n            const state = {\n                data: {\n                    details: { payload: status.props.payload },\n                    paymentData: this.props.paymentData\n                }\n            };\n            this.props.onComplete(state, this);\n        }\n\n        const error = new AdyenCheckoutError('ERROR', 'error result with no payload in response');\n        return this.props.onError(error);\n    };\n\n    private checkStatus = () => {\n        const { paymentData, clientKey, loadingContext, throttledInterval } = this.props;\n\n        return checkPaymentStatus(paymentData, clientKey, loadingContext, throttledInterval)\n            .then(processResponse)\n            .catch(response => ({ type: 'network-error', props: response }))\n            .then((status: StatusObject) => {\n                switch (status.type) {\n                    case 'success':\n                        this.onComplete(status);\n                        break;\n                    case 'error':\n                        this.onError(status);\n                        break;\n                    default:\n                        this.setState({ loading: false });\n                }\n                return status;\n            });\n    };\n\n    render({ amount, url, brandLogo, brandName, countdownTime, type, onActionHandled }: QRLoaderProps, { expired, completed, loading }) {\n        const { i18n, loadingContext } = useCoreContext();\n        const getImage = useImage();\n        const qrCodeImage = this.props.qrCodeData ? `${loadingContext}${QRCODE_URL}${this.props.qrCodeData}` : this.props.qrCodeImage;\n        const finalState = (image, message) => {\n            const status = i18n.get(message);\n            useA11yReporter(status);\n            return (\n                <div className=\"adyen-checkout__qr-loader adyen-checkout__qr-loader--result\">\n                    <img\n                        className=\"adyen-checkout__qr-loader__icon adyen-checkout__qr-loader__icon--result\"\n                        src={getImage({ imageFolder: 'components/' })(image)}\n                        alt={status}\n                    />\n                    <div className=\"adyen-checkout__qr-loader__subtitle\">{status}</div>\n                </div>\n            );\n        };\n\n        if (expired) {\n            return finalState('error', 'error.subtitle.payment');\n        }\n\n        if (completed) {\n            return finalState('success', 'creditCard.success');\n        }\n\n        if (loading) {\n            return (\n                <div className=\"adyen-checkout__qr-loader\">\n                    {brandLogo && (\n                        <div className=\"adyen-checkout__qr-loader__brand-logo-wrapper\">\n                            <img alt={brandName} src={brandLogo} className=\"adyen-checkout__qr-loader__brand-logo\" />\n                        </div>\n                    )}\n                    <Spinner />\n                </div>\n            );\n        }\n\n        const timeToPayString = i18n.get(this.props.timeToPay).split('%@');\n\n        const qrSubtitleRef = useAutoFocus();\n        const classnames = this.props.classNameModifiers.map(m => `adyen-checkout__qr-loader--${m}`);\n\n        return (\n            <div className={`adyen-checkout__qr-loader adyen-checkout__qr-loader--${type} ${classnames.join(' ')}`}>\n                {brandLogo && (\n                    <div className=\"adyen-checkout__qr-loader__brand-logo-wrapper\">\n                        <img src={brandLogo} alt={brandName} className=\"adyen-checkout__qr-loader__brand-logo\" />\n                    </div>\n                )}\n\n                {amount && amount.value && amount.currency && (\n                    <div className=\"adyen-checkout__qr-loader__payment_amount\">{i18n.amount(amount.value, amount.currency)}</div>\n                )}\n\n                {url && (\n                    <div className=\"adyen-checkout__qr-loader__app-link\">\n                        {this.props.redirectIntroduction && (\n                            <div className=\"adyen-checkout__qr-loader__subtitle\">{i18n.get(this.props.redirectIntroduction)}</div>\n                        )}\n                        <Button classNameModifiers={['qr-loader']} onClick={() => this.redirectToApp(url)} label={i18n.get(this.props.buttonLabel)} />\n                        <ContentSeparator />\n                    </div>\n                )}\n\n                {/* eslint-disable-next-line jsx-a11y/no-noninteractive-tabindex */}\n                <div ref={qrSubtitleRef} tabIndex={0} className=\"adyen-checkout__qr-loader__subtitle\">\n                    {typeof this.props.introduction === 'string' ? i18n.get(this.props.introduction) : this.props.introduction?.()}\n                </div>\n\n                <img\n                    src={qrCodeImage}\n                    alt={i18n.get('wechatpay.scanqrcode')}\n                    onLoad={() => {\n                        onActionHandled?.({\n                            componentType: this.props.type,\n                            actionDescription: 'qr-code-loaded'\n                        });\n                    }}\n                />\n\n                <div className=\"adyen-checkout__qr-loader__progress\">\n                    <span className=\"adyen-checkout__qr-loader__percentage\" style={{ width: `${this.state.percentage}%` }} />\n                </div>\n\n                <div className=\"adyen-checkout__qr-loader__countdown\">\n                    {timeToPayString[0]}&nbsp;\n                    <Countdown minutesFromNow={countdownTime} onTick={this.onTick} onCompleted={this.onTimeUp} />\n                    &nbsp;{timeToPayString[1]}\n                </div>\n\n                {this.props.instructions && (\n                    <div className=\"adyen-checkout__qr-loader__instructions\">\n                        {typeof this.props.instructions === 'string' ? i18n.get(this.props.instructions) : this.props.instructions?.()}\n                    </div>\n                )}\n\n                {this.props.copyBtn && (\n                    <div className=\"adyen-checkout__qr-loader__actions\">\n                        <Button\n                            inline\n                            variant=\"action\"\n                            onClick={(e, { complete }) => {\n                                copyToClipboard(this.props.qrCodeData);\n                                this.props.onSubmitAnalytics({\n                                    type: ANALYTICS_DOWNLOAD_STR,\n                                    target: ANALYTICS_QR_CODE_DOWNLOAD\n                                });\n                                complete();\n                            }}\n                            icon={getImage({ imageFolder: 'components/' })(`${PREFIX}copy`)}\n                            label={i18n.get('button.copy')}\n                        />\n                    </div>\n                )}\n            </div>\n        );\n    }\n}\n\nexport default QRLoader;\n"],"names":["QRLoader","Component","componentDidMount","this","statusInterval","componentWillUnmount","clearTimeout","timeoutId","pollStatus","delay","setTimeout","async","start","performance","now","checkStatus","end","Math","round","render","amount","url","brandLogo","brandName","countdownTime","type","onActionHandled","expired","completed","loading","_this_props_introduction","_this_props","_this_props_instructions","_this_props1","i18n","loadingContext","useCoreContext","getImage","useImage","qrCodeImage","props","qrCodeData","finalState","image","message","status","get","useA11yReporter","h","div","className","img","src","imageFolder","alt","Spinner","timeToPayString","timeToPay","split","qrSubtitleRef","useAutoFocus","classnames","classNameModifiers","map","m","join","value","currency","redirectIntroduction","Button","onClick","redirectToApp","label","buttonLabel","ContentSeparator","ref","tabIndex","introduction","call","onLoad","componentType","actionDescription","span","style","width","state","percentage","Countdown","minutesFromNow","onTick","onCompleted","onTimeUp","instructions","copyBtn","inline","variant","e","complete","copyToClipboard","onSubmitAnalytics","ANALYTICS_DOWNLOAD_STR","target","ANALYTICS_QR_CODE_DOWNLOAD","icon","PREFIX","constructor","super","_define_property","window","location","assign","responseTime","setState","previous","timePassed","newDelay","throttleTime","throttledInterval","time","onError","AdyenCheckoutError","onComplete","data","details","payload","paymentData","error","clientKey","checkPaymentStatus","then","processResponse","catch","response","buttonStatus","defaultProps"],"mappings":"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"}