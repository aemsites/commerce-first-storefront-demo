{"version":3,"file":"QRLoader.js","sources":["../../../../../src/components/internal/QRLoader/QRLoader.tsx"],"sourcesContent":["import { Component, h } from 'preact';\nimport Countdown from '../Countdown';\nimport Button from '../Button';\nimport Spinner from '../Spinner';\nimport checkPaymentStatus from '../../../core/Services/payment-status';\nimport processResponse from '../../../core/ProcessResponse';\n\nimport './QRLoader.scss';\nimport { QRLoaderProps, QRLoaderState } from './types';\nimport copyToClipboard from '../../../utils/clipboard';\nimport AdyenCheckoutError from '../../../core/Errors/AdyenCheckoutError';\nimport { useCoreContext } from '../../../core/Context/CoreProvider';\nimport ContentSeparator from '../ContentSeparator';\nimport { StatusObject } from '../Await/types';\nimport useImage from '../../../core/Context/useImage';\nimport { useA11yReporter } from '../../../core/Errors/useA11yReporter';\nimport useAutoFocus from '../../../utils/useAutoFocus';\nimport { ANALYTICS_DOWNLOAD_STR, ANALYTICS_QR_CODE_DOWNLOAD } from '../../../core/Analytics/constants';\nimport { PREFIX } from '../Icon/constants';\n\nconst QRCODE_URL = 'barcode.shtml?barcodeType=qrCode&fileType=png&data=';\n\nclass QRLoader extends Component<QRLoaderProps, QRLoaderState> {\n    private timeoutId;\n\n    constructor(props) {\n        super(props);\n\n        this.state = {\n            buttonStatus: 'default',\n            completed: false,\n            delay: props.delay,\n            expired: false,\n            loading: true,\n            percentage: 100,\n            timePassed: 0\n        };\n    }\n\n    public static defaultProps = {\n        delay: 2000,\n        countdownTime: 15,\n        onError: () => {},\n        onComplete: () => {},\n        throttleTime: 60000,\n        classNameModifiers: [],\n        throttledInterval: 10000,\n        introduction: 'wechatpay.scanqrcode',\n        timeToPay: 'wechatpay.timetopay',\n        buttonLabel: 'openApp'\n    };\n\n    componentDidMount() {\n        this.statusInterval();\n    }\n\n    componentWillUnmount() {\n        clearTimeout(this.timeoutId);\n    }\n\n    public redirectToApp = (url: string | URL) => {\n        window.location.assign(url);\n    };\n\n    // Retry until getting a complete response from the server, or it times out\n    public statusInterval = (responseTime = 0) => {\n        // If we are already in the final statuses, do not poll!\n        if (this.state.expired || this.state.completed) return;\n\n        this.setState(previous => ({ timePassed: previous.timePassed + this.props.delay + responseTime }));\n        // Changes interval time to 10 seconds after 1 minute (60 seconds)\n        const newDelay = this.state.timePassed >= this.props.throttleTime ? this.props.throttledInterval : this.state.delay;\n        this.pollStatus(newDelay);\n    };\n\n    private pollStatus(delay: number) {\n        clearTimeout(this.timeoutId);\n\n        // eslint-disable-next-line @typescript-eslint/no-misused-promises\n        this.timeoutId = setTimeout(async () => {\n            // Wait for previous status call to finish.\n            // Also taking the server response time into the consideration to calculate timePassed.\n            const start = performance.now();\n            await this.checkStatus();\n            const end = performance.now();\n            this.statusInterval(Math.round(end - start));\n        }, delay);\n    }\n\n    private onTick = (time): void => {\n        this.setState({ percentage: time.percentage });\n    };\n\n    private onTimeUp = (): void => {\n        this.setState({ expired: true });\n        clearTimeout(this.timeoutId);\n        this.props.onError(new AdyenCheckoutError('ERROR', 'Payment Expired'));\n    };\n\n    private onComplete = (status: StatusObject): void => {\n        clearTimeout(this.timeoutId);\n        this.setState({ completed: true, loading: false });\n\n        const state = {\n            data: {\n                details: { payload: status.props.payload },\n                paymentData: this.props.paymentData\n            }\n        };\n\n        this.props.onComplete(state, this);\n    };\n\n    private onError = (status: StatusObject): void => {\n        clearTimeout(this.timeoutId);\n        this.setState({ expired: true, loading: false });\n\n        if (status.props.payload) {\n            const state = {\n                data: {\n                    details: { payload: status.props.payload },\n                    paymentData: this.props.paymentData\n                }\n            };\n            this.props.onComplete(state, this);\n        }\n\n        const error = new AdyenCheckoutError('ERROR', 'error result with no payload in response');\n        return this.props.onError(error);\n    };\n\n    private checkStatus = () => {\n        const { paymentData, clientKey, loadingContext, throttledInterval } = this.props;\n\n        return checkPaymentStatus(paymentData, clientKey, loadingContext, throttledInterval)\n            .then(processResponse)\n            .catch(response => ({ type: 'network-error', props: response }))\n            .then((status: StatusObject) => {\n                switch (status.type) {\n                    case 'success':\n                        this.onComplete(status);\n                        break;\n                    case 'error':\n                        this.onError(status);\n                        break;\n                    default:\n                        this.setState({ loading: false });\n                }\n                return status;\n            });\n    };\n\n    render({ amount, url, brandLogo, brandName, countdownTime, type, onActionHandled }: QRLoaderProps, { expired, completed, loading }) {\n        const { i18n, loadingContext } = useCoreContext();\n        const getImage = useImage();\n        const qrCodeImage = this.props.qrCodeData ? `${loadingContext}${QRCODE_URL}${this.props.qrCodeData}` : this.props.qrCodeImage;\n        const finalState = (image, message) => {\n            const status = i18n.get(message);\n            useA11yReporter(status);\n            return (\n                <div className=\"adyen-checkout__qr-loader adyen-checkout__qr-loader--result\">\n                    <img\n                        className=\"adyen-checkout__qr-loader__icon adyen-checkout__qr-loader__icon--result\"\n                        src={getImage({ imageFolder: 'components/' })(image)}\n                        alt={status}\n                    />\n                    <div className=\"adyen-checkout__qr-loader__subtitle\">{status}</div>\n                </div>\n            );\n        };\n\n        if (expired) {\n            return finalState('error', 'error.subtitle.payment');\n        }\n\n        if (completed) {\n            return finalState('success', 'creditCard.success');\n        }\n\n        if (loading) {\n            return (\n                <div className=\"adyen-checkout__qr-loader\">\n                    {brandLogo && (\n                        <div className=\"adyen-checkout__qr-loader__brand-logo-wrapper\">\n                            <img alt={brandName} src={brandLogo} className=\"adyen-checkout__qr-loader__brand-logo\" />\n                        </div>\n                    )}\n                    <Spinner />\n                </div>\n            );\n        }\n\n        const timeToPayString = i18n.get(this.props.timeToPay).split('%@');\n\n        const qrSubtitleRef = useAutoFocus();\n        const classnames = this.props.classNameModifiers.map(m => `adyen-checkout__qr-loader--${m}`);\n\n        return (\n            <div className={`adyen-checkout__qr-loader adyen-checkout__qr-loader--${type} ${classnames.join(' ')}`}>\n                {brandLogo && (\n                    <div className=\"adyen-checkout__qr-loader__brand-logo-wrapper\">\n                        <img src={brandLogo} alt={brandName} className=\"adyen-checkout__qr-loader__brand-logo\" />\n                    </div>\n                )}\n\n                {amount && amount.value && amount.currency && (\n                    <div className=\"adyen-checkout__qr-loader__payment_amount\">{i18n.amount(amount.value, amount.currency)}</div>\n                )}\n\n                {url && (\n                    <div className=\"adyen-checkout__qr-loader__app-link\">\n                        {this.props.redirectIntroduction && (\n                            <div className=\"adyen-checkout__qr-loader__subtitle\">{i18n.get(this.props.redirectIntroduction)}</div>\n                        )}\n                        <Button classNameModifiers={['qr-loader']} onClick={() => this.redirectToApp(url)} label={i18n.get(this.props.buttonLabel)} />\n                        <ContentSeparator />\n                    </div>\n                )}\n\n                {/* eslint-disable-next-line jsx-a11y/no-noninteractive-tabindex */}\n                <div ref={qrSubtitleRef} tabIndex={0} className=\"adyen-checkout__qr-loader__subtitle\">\n                    {typeof this.props.introduction === 'string' ? i18n.get(this.props.introduction) : this.props.introduction?.()}\n                </div>\n\n                <img\n                    src={qrCodeImage}\n                    alt={i18n.get('wechatpay.scanqrcode')}\n                    onLoad={() => {\n                        onActionHandled?.({\n                            componentType: this.props.type,\n                            actionDescription: 'qr-code-loaded'\n                        });\n                    }}\n                />\n\n                <div className=\"adyen-checkout__qr-loader__progress\">\n                    <span className=\"adyen-checkout__qr-loader__percentage\" style={{ width: `${this.state.percentage}%` }} />\n                </div>\n\n                <div className=\"adyen-checkout__qr-loader__countdown\">\n                    {timeToPayString[0]}&nbsp;\n                    <Countdown minutesFromNow={countdownTime} onTick={this.onTick} onCompleted={this.onTimeUp} />\n                    &nbsp;{timeToPayString[1]}\n                </div>\n\n                {this.props.instructions && (\n                    <div className=\"adyen-checkout__qr-loader__instructions\">\n                        {typeof this.props.instructions === 'string' ? i18n.get(this.props.instructions) : this.props.instructions?.()}\n                    </div>\n                )}\n\n                {this.props.copyBtn && (\n                    <div className=\"adyen-checkout__qr-loader__actions\">\n                        <Button\n                            inline\n                            variant=\"action\"\n                            onClick={(e, { complete }) => {\n                                copyToClipboard(this.props.qrCodeData);\n                                this.props.onSubmitAnalytics({\n                                    type: ANALYTICS_DOWNLOAD_STR,\n                                    target: ANALYTICS_QR_CODE_DOWNLOAD\n                                });\n                                complete();\n                            }}\n                            icon={getImage({ imageFolder: 'components/' })(`${PREFIX}copy`)}\n                            label={i18n.get('button.copy')}\n                        />\n                    </div>\n                )}\n            </div>\n        );\n    }\n}\n\nexport default QRLoader;\n"],"names":["QRLoader","Component","componentDidMount","this","statusInterval","componentWillUnmount","clearTimeout","timeoutId","pollStatus","delay","setTimeout","async","start","performance","now","checkStatus","end","Math","round","render","amount","url","brandLogo","brandName","countdownTime","type","onActionHandled","expired","completed","loading","i18n","loadingContext","useCoreContext","getImage","useImage","qrCodeImage","props","qrCodeData","finalState","image","message","status","get","useA11yReporter","h","div","className","img","src","imageFolder","alt","Spinner","timeToPayString","timeToPay","split","qrSubtitleRef","useAutoFocus","classnames","classNameModifiers","map","m","join","value","currency","redirectIntroduction","Button","onClick","redirectToApp","label","buttonLabel","ContentSeparator","ref","tabIndex","introduction","onLoad","componentType","actionDescription","span","style","width","state","percentage","Countdown","minutesFromNow","onTick","onCompleted","onTimeUp","instructions","copyBtn","inline","variant","e","complete","copyToClipboard","onSubmitAnalytics","ANALYTICS_DOWNLOAD_STR","target","ANALYTICS_QR_CODE_DOWNLOAD","icon","PREFIX","constructor","super","_define_property","window","location","assign","responseTime","setState","previous","timePassed","newDelay","throttleTime","throttledInterval","time","onError","AdyenCheckoutError","onComplete","data","details","payload","paymentData","error","clientKey","checkPaymentStatus","then","processResponse","catch","response","buttonStatus","defaultProps"],"mappings":"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"}